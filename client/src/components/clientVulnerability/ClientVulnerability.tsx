'use client'

import { useState, useEffect, Suspense } from 'react'
import { PageTitle, ClientRow, ClientCol, ZAPCard } from '@/components'
import { PolarChart } from '@/components/chart'
import { VulTable, WebScanTable, Spinner } from '@/components'

export default function ClientVulnerability({
  sortedWebscans,
  allZAPscans
}: any) {
  const [selectedWebScanId, setSelectedWebScanId] = useState<string>('')
  const [selectedWebUrl, setSelectedWebUrl] = useState<string>('')
  const [chartScans, setChartScans] = useState(allZAPscans)
  const [selectedZapScanTitle, setSelectedZapScanTitle] = useState<string>('')

  const handleChangeWebUrl = (scanId: string, scanUrl: string) => {
    setSelectedWebScanId(scanId)
    setSelectedWebUrl(scanUrl)
  }

  const handleSelectZAPScan = (scanTitle: string) => {
    setSelectedZapScanTitle(scanTitle)
  }

  useEffect(() => {
    setSelectedWebScanId(sortedWebscans[0].scanId)
    setSelectedWebUrl(sortedWebscans[0].scanUrl)
  }, [sortedWebscans])

  useEffect(() => {
    selectedWebScanId !== '' &&
      setChartScans(
        chartScans
          ? chartScans.filter((item: any) => item.scanId === selectedWebScanId)
          : []
      )
  }, [selectedWebScanId])

  return (
    <Suspense fallback={<Spinner />}>
      <br />
      <ClientRow>
        <ClientCol xs={6}>
          <PolarChart
            title={'Endpoint scale status'}
            scanId={selectedWebScanId}
            data={sortedWebscans}
          />
        </ClientCol>
        <ClientCol xs={6}>
          <VulTable
            data={allZAPscans}
            scanUrl={selectedWebUrl}
            onSelectZapScan={handleSelectZAPScan}
          />
        </ClientCol>
      </ClientRow>
      <ClientRow>
        <ClientCol xs={6}>
          <WebScanTable
            data={sortedWebscans}
            onChangeWebUrl={handleChangeWebUrl}
          />
        </ClientCol>
        <ClientCol xs={6}>
          <ZAPCard
            title="General"
            data={allZAPscans}
            scanUrl={selectedWebUrl}
            scanTitle={selectedZapScanTitle}
          />
        </ClientCol>
      </ClientRow>
    </Suspense>
  )
}
