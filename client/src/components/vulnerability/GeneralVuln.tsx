'use client'

import { useState, useEffect, lazy } from 'react'
import { ClientRow, ClientCol } from '@/components'
import { WebScanService } from '@/service/api'
import { sortWebScansByLatestDate } from '@/helpers'
import {
  VulnDataTable,
  WebScanDataTable,
  VulnPolarChart,
  ZapScanDataTable
} from '@/components'

export default function GeneralVuln() {
  const [selectedWebScanId, setSelectedWebScanId] = useState<string | null>(
    null
  )
  const [selectedWebUrl, setSelectedWebUrl] = useState<string | null>(null)
  const [selectedVulnId, setSelectedVulnId] = useState<string | null>(null)

  const [webScanData, setWebScanData] = useState([])

  const handleChangeWebUrl = (scanId: string, scanUrl: string) => {
    setSelectedWebScanId(scanId)
    setSelectedWebUrl(scanUrl)
    setSelectedVulnId(null)
  }

  const handleSelectZAPScan = (vulnId: string) => {
    setSelectedVulnId(vulnId)
  }

  useEffect(() => {
    const fetchLatestWebScanData = async () => {
      const fetchedData = await new WebScanService().getWebScansByProjectId(
        '762b2817-ce6a-4326-8058-a6af902572dd'
      )
      const sortData = sortWebScansByLatestDate(fetchedData)
      setWebScanData(sortData)
      setSelectedWebUrl(sortData[0].scanUrl)
      setSelectedWebScanId(sortData[0].scanId)
    }
    fetchLatestWebScanData()
  }, [])

  return (
    <>
      <br />
      <ClientRow>
        <ClientCol xs={6}>
          <VulnPolarChart webScanId={selectedWebScanId} />
        </ClientCol>
        <ClientCol xs={6}>
          <VulnDataTable
            scanUrl={selectedWebUrl}
            onSelectZapScan={handleSelectZAPScan}
          />
        </ClientCol>
      </ClientRow>
      <ClientRow>
        <ClientCol xs={6}>
          <WebScanDataTable
            onChangeWebUrl={handleChangeWebUrl}
            data={webScanData}
          />
        </ClientCol>
        <ClientCol xs={6}>
          <ZapScanDataTable scanUrl={selectedWebUrl} vulnId={selectedVulnId} />
        </ClientCol>
      </ClientRow>
    </>
  )
}
